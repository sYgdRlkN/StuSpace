# ä¸€ã€åç«¯è®¾è®¡æ€»è§ˆï¼ˆå…ˆç»™ä½ ä¸€å¼ â€œè€å¸ˆè§†è§’â€çš„å›¾ï¼‰

| æ¨¡å—       | åŠŸèƒ½                     | æ˜¯å¦åŠ åˆ† |
| ---------- | ------------------------ | -------- |
| é¢„çº¦æ¥å£   | é˜²é‡å¤ + æ—¶é—´å†²çª + äº‹åŠ¡ | â­â­â­      |
| æˆ‘çš„é¢„çº¦   | å½“å‰é¢„çº¦ + å†å²é¢„çº¦      | â­â­â­      |
| ç®¡ç†å‘˜æ€»è§ˆ | ç©ºé—´ / é¢„çº¦ç»Ÿè®¡          | â­â­â­â­     |

ä½ è¿™å·²ç»æ˜¯**å®Œæ•´ä¸šåŠ¡é—­ç¯**äº†ã€‚

------

# äºŒã€å®Œæ•´ `views.py`ï¼ˆæ ¸å¿ƒï¼‰

> ä¸‹é¢ä»£ç å‡è®¾ä½ å·²æœ‰æ¨¡å‹ï¼š
>
> - `Space(space_id, name, capacity, ...)`
> - `Reservation(user_id, space, start_time, end_time, status)`
> - `User(id, username, is_admin)`ï¼ˆæˆ–ç±»ä¼¼ï¼‰

------

## 1ï¸âƒ£ é¢„çº¦æ¥å£ï¼ˆé˜²é‡å¤ + æ—¶é—´å†²çªï¼‰

### âœ… `reserve_space`

```
from django.http import JsonResponse
from django.db import transaction
from datetime import datetime
from .models import Space, Reservation
import json

@transaction.atomic
def reserve_space(request):
    if request.method != "POST":
        return JsonResponse({"msg": "method not allowed"}, status=405)

    data = json.loads(request.body)
    user_id = data["user_id"]
    space_id = data["space_id"]

    start_time = datetime.fromisoformat(
        data["start_time"].replace("Z", "+00:00")
    )
    end_time = datetime.fromisoformat(
        data["end_time"].replace("Z", "+00:00")
    )

    # é”å®šç©ºé—´ï¼Œé˜²å¹¶å‘
    try:
        space = Space.objects.select_for_update().get(space_id=space_id)
    except Space.DoesNotExist:
        return JsonResponse({"msg": "space not found"}, status=404)

    # 1ï¸âƒ£ å®¹é‡æ£€æŸ¥
    if space.capacity <= 0:
        return JsonResponse({"msg": "no capacity"}, status=400)

    # 2ï¸âƒ£ é˜²æ­¢åŒä¸€ç”¨æˆ·é‡å¤é¢„çº¦åŒä¸€ç©ºé—´
    if Reservation.objects.filter(
        user_id=user_id,
        space=space,
        status="reserved"
    ).exists():
        return JsonResponse({"msg": "duplicate reservation"}, status=400)

    # 3ï¸âƒ£ æ—¶é—´å†²çªæ£€æµ‹ï¼ˆåŒä¸€ç”¨æˆ·ï¼‰
    conflict = Reservation.objects.filter(
        user_id=user_id,
        status="reserved",
        start_time__lt=end_time,
        end_time__gt=start_time
    ).exists()

    if conflict:
        return JsonResponse({"msg": "time conflict"}, status=400)

    # åˆ›å»ºé¢„çº¦
    Reservation.objects.create(
        user_id=user_id,
        space=space,
        start_time=start_time,
        end_time=end_time,
        status="reserved"
    )

    # å®¹é‡ -1
    space.capacity -= 1
    space.save()

    return JsonResponse({"msg": "success"})
```

------

### ğŸ¤ ç­”è¾©å¯ä»¥è¿™æ ·è¯´

> é¢„çº¦æ¥å£é€šè¿‡æ•°æ®åº“äº‹åŠ¡ä¸è¡Œçº§é”ï¼Œ
>  åŒæ—¶åœ¨ä¸šåŠ¡å±‚é¢é˜²æ­¢é‡å¤é¢„çº¦å’Œæ—¶é—´å†²çªï¼Œ
>  ä¿è¯å¹¶å‘åœºæ™¯ä¸‹æ•°æ®ä¸€è‡´æ€§ã€‚

------

# ä¸‰ã€æˆ‘çš„é¢„çº¦æ¨¡å—ï¼ˆå½“å‰ + å†å²ï¼‰

## 2ï¸âƒ£ æŸ¥è¯¢æˆ‘çš„é¢„çº¦

### è®¾è®¡è¯´æ˜

- **å½“å‰é¢„çº¦**ï¼š`status = 'reserved'`
- **å†å²é¢„çº¦**ï¼š`cancelled / completed`
- å‰ç«¯ä¸€ä¸ªé¡µé¢å³å¯ï¼Œç”¨ Tab åˆ‡æ¢

------

### âœ… `my_reservations`

```
def my_reservations(request):
    user_id = request.GET.get("user_id")
    if not user_id:
        return JsonResponse({"msg": "missing user_id"}, status=400)

    reservations = Reservation.objects.filter(
        user_id=user_id
    ).select_related("space").order_by("-start_time")

    result = []
    for r in reservations:
        result.append({
            "space_name": r.space.name,
            "location": r.space.location,
            "start_time": r.start_time,
            "end_time": r.end_time,
            "status": r.status
        })

    return JsonResponse(result, safe=False)
```

------

### ğŸ¤ ç­”è¾©äº®ç‚¹

> é€šè¿‡é¢„çº¦çŠ¶æ€åŒºåˆ†å½“å‰ä¸å†å²é¢„çº¦ï¼Œ
>  æä¾›å®Œæ•´çš„ç”¨æˆ·è¡Œä¸ºè®°å½•ã€‚

------

# å››ã€ç®¡ç†å‘˜æ€»è§ˆæ¨¡å—ï¼ˆéå¸¸åŠ åˆ†ï¼‰

> è¿™ä¸ªæ˜¯**è€å¸ˆæœ€å–œæ¬¢çœ‹åˆ°çš„éƒ¨åˆ†**ï¼Œ
>  å› ä¸ºå®ƒä½“ç°äº†ã€Œç³»ç»Ÿè§†è§’ã€ã€‚

------

## 3ï¸âƒ£ ç®¡ç†å‘˜æ€»è§ˆæ¥å£

### åŠŸèƒ½åŒ…æ‹¬ï¼š

- å­¦ä¹ ç©ºé—´æ€»æ•°
- å½“å‰å¯ç”¨æ€»åº§ä½
- å½“å‰æœ‰æ•ˆé¢„çº¦æ•°
- å†å²é¢„çº¦æ•°

------

### âœ… `admin_overview`

```
from django.db.models import Sum, Count

def admin_overview(request):
    user_id = request.GET.get("user_id")

    # âš ï¸ ç®€åŒ–åˆ¤æ–­ï¼ˆå‡è®¾ is_admin å­—æ®µï¼‰
    from .models import User
    user = User.objects.get(id=user_id)
    if not user.is_admin:
        return JsonResponse({"msg": "permission denied"}, status=403)

    total_spaces = Space.objects.count()
    total_capacity = Space.objects.aggregate(
        total=Sum("capacity")
    )["total"] or 0

    active_reservations = Reservation.objects.filter(
        status="reserved"
    ).count()

    history_reservations = Reservation.objects.exclude(
        status="reserved"
    ).count()

    return JsonResponse({
        "total_spaces": total_spaces,
        "total_capacity": total_capacity,
        "active_reservations": active_reservations,
        "history_reservations": history_reservations
    })
```

------

### ğŸ¤ è€å¸ˆä¼šéå¸¸è®¤å¯çš„ç‚¹

> åŒºåˆ†æ™®é€šç”¨æˆ·ä¸ç®¡ç†å‘˜è§’è‰²ï¼Œ
>  ç®¡ç†å‘˜å¯ä»ç³»ç»Ÿè§†è§’æŸ¥çœ‹æ•´ä½“ä½¿ç”¨æƒ…å†µã€‚

------

# äº”ã€`urls.py`ï¼ˆåˆ«å¿˜äº†ï¼‰

```
from django.urls import path
from . import views

urlpatterns = [
    path("reserve/", views.reserve_space),
    path("my_reservations/", views.my_reservations),
    path("admin/overview/", views.admin_overview),
]
```





# ä¸€ã€å‰ç«¯æ•´ä½“ç»“æ„ï¼ˆå…ˆç»Ÿä¸€è®¤çŸ¥ï¼‰

## âœ… é¡µé¢ç»“æ„å»ºè®®ï¼ˆéå¸¸åˆç†ï¼‰

```
frontend/
â”‚â”€â”€ login.html          ç™»å½•é¡µ
â”‚â”€â”€ index.html          å­¦ä¹ ç©ºé—´åˆ—è¡¨ï¼ˆä¸»é¡µé¢ï¼‰
â”‚â”€â”€ my_reservations.html æˆ‘çš„é¢„çº¦
â”‚â”€â”€ admin.html          ç®¡ç†å‘˜æ€»è§ˆ
â”‚â”€â”€ main.js             ä¸šåŠ¡é€»è¾‘
â”‚â”€â”€ ui.css              ç»Ÿä¸€æ ·å¼
```

ğŸ‘‰ **è¿™æ˜¯å·¥ç¨‹åŒ–ç»“æ„ï¼Œç­”è¾©å¯ä»¥ç›´æ¥å±•ç¤ºç›®å½•**

------

# äºŒã€æ•´ä½“ UI é£æ ¼ï¼ˆä½ ä»¬ç»Ÿä¸€ç…§è¿™ä¸ªæ¥ï¼‰

### ğŸ¨ UI ç›®æ ‡å…³é”®è¯ï¼ˆä½ å¯ä»¥ç›´æ¥å†™åœ¨æŠ¥å‘Šé‡Œï¼‰

- å¡ç‰‡åŒ–ï¼ˆCardï¼‰
- çŠ¶æ€å¯è§†åŒ–ï¼ˆé¢œè‰² / badgeï¼‰
- éé˜»å¡åé¦ˆï¼ˆæç¤ºæ¡è€Œä¸æ˜¯ alertï¼‰
- æ˜ç¡®æ“ä½œå¼•å¯¼

------

# ä¸‰ã€ç»Ÿä¸€æ ·å¼ï¼ˆui.cssï¼Œç›´æ¥æ–°å»ºï¼‰

ğŸ‘‰ **æ‰€æœ‰é¡µé¢éƒ½å¼•å…¥å®ƒ**

```
body {
    background-color: #f6f8fb;
    font-family: "Segoe UI", "PingFang SC", sans-serif;
}

.navbar {
    background-color: #2563eb;
}

.navbar-brand {
    color: #fff;
    font-weight: bold;
}

.container {
    margin-top: 30px;
}

.card {
    border-radius: 12px;
}

.badge-success {
    background-color: #22c55e;
}

.badge-warning {
    background-color: #facc15;
    color: #000;
}

.badge-danger {
    background-color: #ef4444;
}

button {
    border-radius: 8px !important;
}
```

------

# å››ã€ä¸»é¡µé¢ï¼ˆindex.htmlï¼‰â€”â€”æ ¸å¿ƒäº¤äº’é¡µ

ğŸ‘‰ **å®Œæ•´æ›¿æ¢**

```
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å­¦ä¹ ç©ºé—´é¢„çº¦ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="ui.css" rel="stylesheet">
</head>
<body>

<nav class="navbar px-4">
    <span class="navbar-brand">å­¦ä¹ ç©ºé—´é¢„çº¦ç³»ç»Ÿ</span>
    <div class="ms-auto">
        <a href="my_reservations.html" class="btn btn-light btn-sm me-2">æˆ‘çš„é¢„çº¦</a>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">é€€å‡º</button>
    </div>
</nav>

<div class="container">
    <div id="msgBox"></div>

    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="mb-3">å¯ç”¨å­¦ä¹ ç©ºé—´</h5>

            <table class="table align-middle">
                <thead>
                <tr>
                    <th>åç§°</th>
                    <th>ä½ç½®</th>
                    <th>å®¹é‡</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
                </thead>
                <tbody id="spaceTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="main.js"></script>
</body>
</html>
```

------

# äº”ã€ä¸»é¡µé¢ JS æ¸²æŸ“ï¼ˆå¢å¼ºäº¤äº’ï¼‰

ğŸ‘‰ **ç›´æ¥æ›¿æ¢ `loadSpaces()`**

```
function loadSpaces() {
    fetch(`${API_BASE}/spaces/`)
        .then(res => res.json())
        .then(data => {
            const table = document.getElementById("spaceTable");
            table.innerHTML = "";

            data.forEach(space => {
                let badge, disabled = "";

                if (space.capacity > 5) {
                    badge = `<span class="badge badge-success">å……è¶³</span>`;
                } else if (space.capacity > 0) {
                    badge = `<span class="badge badge-warning">ç´§å¼ </span>`;
                } else {
                    badge = `<span class="badge badge-danger">å·²æ»¡</span>`;
                    disabled = "disabled";
                }

                table.innerHTML += `
                <tr>
                    <td>${space.name}</td>
                    <td>${space.location}</td>
                    <td>${space.capacity}</td>
                    <td>${badge}</td>
                    <td>
                        <button class="btn btn-success btn-sm"
                            ${disabled}
                            onclick="reserve(${space.space_id})">
                            é¢„çº¦
                        </button>
                    </td>
                </tr>
                `;
            });
        });
}
```

ğŸ“Œ **è¿™ä¸€æ®µ=å®¹é‡å¯è§†åŒ– + äº¤äº’å¢å¼º**

------

# å…­ã€â€œæˆ‘çš„é¢„çº¦â€é¡µé¢ï¼ˆéå¸¸åŠ åˆ†ï¼‰

## my_reservations.htmlï¼ˆå®Œæ•´ï¼‰

```
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„é¢„çº¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="ui.css" rel="stylesheet">
</head>
<body>

<nav class="navbar px-4">
    <span class="navbar-brand">æˆ‘çš„é¢„çº¦</span>
    <div class="ms-auto">
        <a href="index.html" class="btn btn-light btn-sm">è¿”å›</a>
    </div>
</nav>

<div class="container">
    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table">
                <thead>
                <tr>
                    <th>ç©ºé—´</th>
                    <th>æ—¶é—´</th>
                    <th>çŠ¶æ€</th>
                </tr>
                </thead>
                <tbody id="myTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="main.js"></script>
<script>
    loadMyReservations();
</script>

</body>
</html>
```

------

## main.jsï¼šæ–°å¢å‡½æ•°

```
function loadMyReservations() {
    const userId = localStorage.getItem("user_id");

    fetch(`${API_BASE}/my_reservations/?user_id=${userId}`)
        .then(res => res.json())
        .then(data => {
            const table = document.getElementById("myTable");
            table.innerHTML = "";

            data.forEach(r => {
                let badge =
                    r.status === "reserved"
                        ? `<span class="badge badge-success">è¿›è¡Œä¸­</span>`
                        : `<span class="badge badge-secondary">å·²ç»“æŸ</span>`;

                table.innerHTML += `
                <tr>
                    <td>${r.space_name}</td>
                    <td>${r.start_time} ~ ${r.end_time}</td>
                    <td>${badge}</td>
                </tr>
                `;
            });
        });
}
```

------

# ä¸ƒã€äº¤äº’æ€§å¢å¼ºæ€»ç»“ï¼ˆä½ å¯ä»¥ç›´æ¥å†™è¿›æŠ¥å‘Šï¼‰

- çŠ¶æ€é¢œè‰²åé¦ˆï¼ˆå®¹é‡ã€é¢„çº¦çŠ¶æ€ï¼‰
- æ“ä½œæŒ‰é’®åŠ¨æ€ç¦ç”¨
- éé˜»å¡æç¤ºåé¦ˆ
- é¡µé¢è·³è½¬é€»è¾‘æ¸…æ™°
- æ•°æ®å˜åŒ–å³æ—¶åˆ·æ–°